<!DOCTYPE html>
<html>


<body>

<video hidden controls id="test">
  <source src="media/duck.mp4" type='video/mp4'>
</video>

<p>Not Meant For Public to See. Reload Page to Change FPS.</p>
Play at <input type="number" id="FPS" value="60"> FPS
<button onclick="startVideo()">Play</button>
<button onclick="pause()">Pause</button>
<button onclick="reset()">Reset</button>
<button onclick="mute()">Mute</button>
<button onclick="unmute()">Unmute</button>


<br></br>


<canvas id="window" width="640px" height="480px" style="border:1px solid #d3d3d3;"></canvas>

<p>Filters</p>
<button onclick="switchOn('age')">Age</button>
<button onclick="switchOn('blackAndwhite')">Black and White</button>
<button onclick="switchOn('detectEdge')">Detect Edge</button>
<button onclick="switchOn()">Revert</button>



</body>

<script>
var fps;
var v = document.getElementById("test");
var c = document.getElementById("window");

function getFPS() {
	fps = document.getElementById("FPS").value;
}

function pause() {
	document.getElementById("test").pause();
}

function mute() {
	document.getElementById("test").volume = 0;
}

function unmute() {
	document.getElementById("test").volume = 0.5;
}


function reset() {
	pause();
	document.getElementById("test").currentTime = 0;
	startVideo();
}


function drawFrame() {
	var ctx = c.getContext("2d");
	ctx.drawImage(v,5,5,c.width-10,c.height-10);
	chooseFilter();	
}

var ageChoose = false;
var blackAndwhiteChoose = false;
var edgeDetectChoose = false;


function switchOn(filter) {
	if(filter == 'age') {
		ageChoose = true; 
		blackAndwhiteChoose = false;
		edgeDetectChoose = false;
	}
	else if(filter == 'blackAndwhite') {
		blackAndwhiteChoose = true;
		ageChoose = false;
		edgeDetectChoose = false;
	}
	else if(filter == 'detectEdge') {
		edgeDetectChoose = true;
	}
	else {
		ageChoose = false;
		blackAndwhiteChoose = false; 
		edgeDetectChoose = false; 
	}
}

function chooseFilter() {
	if(ageChoose == true) {
		age();
	}
	if(blackAndwhiteChoose == true) {
		blackAndwhite();
	}
	if(edgeDetectChoose == true) {
		detectEdge();
	}

}

function age() {
	var canvas = document.getElementById("window");
	var ctx = canvas.getContext("2d");
	var imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
	console.log(imgData);
	for(var i = 0; i < imgData.data.length; i += 4) {
		var red = imgData.data[i];
		var green = imgData.data[i + 1];
		var blue = imgData.data[i + 2];
		var alpha = imgData.data[i + 3];
		var age = (red + green + blue) / 5;
		imgData.data[i] = age * 1.6;
		imgData.data[i + 1] = age * 1.6;
		imgData.data[i + 2] = age;
		imgData.data[i + 3] = alpha;
	}
	 ctx.putImageData(imgData, 0, 0);
	}

function blackAndwhite() {
	var canvas = document.getElementById("window");
	var ctx = canvas.getContext("2d");
	var imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
	console.log(imgData);
	for(var i = 0; i < imgData.data.length; i += 4) {
		var red = imgData.data[i];
		var green = imgData.data[i + 1];
		var blue = imgData.data[i + 2];
		var alpha = imgData.data[i + 3];
		var grayscale = (red + green + blue) / 3;
		imgData.data[i] = grayscale;
		imgData.data[i + 1] = grayscale;
		imgData.data[i + 2] = grayscale;
		imgData.data[i + 3] = alpha;
	}
	 ctx.putImageData(imgData, 0, 0);
}

function detectEdge() {
	var canvas = document.getElementById("window");
	var ctx = canvas.getContext("2d");
	var imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
	ctx.putImageData(imgData, 0, 0);
	var data = imgData.data;
	var width = imgData.width;
	var limit = data.length;
	for(var i = 0; i < limit; i++) {
		if( i%4 == 3 ) {
			continue;
		} 
		data[i] = 127 + 2*data[i] - data[i + 4] - data[i + width*4];
	}
	ctx.putImageData(imgData, 0, 0);
}



function startVideo() {
	getFPS();

	var ctx = c.getContext("2d");
	var time = 1000 / fps;
	var i;

	document.getElementById("test").play();
	v.addEventListener("play", function() {i = window.setInterval(drawFrame,time);}, true);
	v.addEventListener("pause", function() {window.clearInterval(i);}, true);
	v.addEventListener("ended", function() {clearInterval(i);}, true); 
}

</script>

</html>
